name: Build & Release Tauri App

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'release' to proceed"
        required: true
      release_notes:
        description: "Release notes (Markdown supported)"
        required: false

permissions:
  contents: write
  packages: write

jobs:
  bump-version:
    if: github.event.inputs.confirm == 'release'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      release_tag: ${{ steps.get_version.outputs.release_tag }}
      bump_sha: ${{ steps.commit_version.outputs.bump_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Bump version
        id: get_version
        shell: bash
        run: |
          python - <<'PY'
          import json, os, re

          def inc(v):
              p = [int(x) for x in v.split('.')]
              p[-1] += 1
              return '.'.join(map(str, p))

          try:
              with open('VERSION') as f:
                  cur = f.read().strip()
          except FileNotFoundError:
              cur = '1.0.0'

          new = inc(cur)
          print(f"{cur} -> {new}")

          open('VERSION','w').write(new)

          if os.path.exists('package.json'):
              pkg = json.load(open('package.json'))
              pkg['version'] = new
              json.dump(pkg, open('package.json','w'), indent=2)

          tc = 'src-tauri/tauri.conf.json'
          if os.path.exists(tc):
              t = json.load(open(tc))
              t['version'] = new
              json.dump(t, open(tc,'w'), indent=2)

          cargo = 'src-tauri/Cargo.toml'
          if os.path.exists(cargo):
              s = open(cargo).read()
              s = re.sub(r'^version = ".*"', f'version = "{new}"', s, flags=re.M)
              open(cargo,'w').write(s)

          with open(os.environ['GITHUB_OUTPUT'],'a') as o:
              o.write(f"version={new}\n")
              o.write(f"release_tag=v{new}\n")
          PY

      - name: Commit and push version bump
        id: commit_version
        shell: bash
        run: |
          git config user.name "pamod-madubashana"
          git config user.email "pamod.main@gmail.com"

          git add VERSION package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
          git commit -m "release: v${{ steps.get_version.outputs.version }}"
          git push origin main

          echo "bump_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  build:
    needs: bump-version
    if: github.event.inputs.confirm == 'release'
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    env:
      TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.bump_sha }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Linux deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - run: npm install
      - run: npm install -g @tauri-apps/cli

      - name: Disable macOS signing
        if: matrix.os == 'macos-latest'
        run: |
          echo "TAURI_SIGNING_PRIVATE_KEY=" >> $GITHUB_ENV
          echo "TAURI_SIGNING_PASSWORD=" >> $GITHUB_ENV

      - name: macOS deps
        if: matrix.os == 'macos-latest'
        run: brew install create-dmg

      - name: Build
        run: npm run tauri build

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: src-tauri/target/release/bundle/**/*
          if-no-files-found: error

  publish:
    needs: [bump-version, build]
    if: github.event.inputs.confirm == 'release'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.bump_sha }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - run: |
          mkdir release-files

          for os in windows-latest ubuntu-latest macos-latest; do
            mkdir -p release-files/$os
            cp -r artifacts/$os-artifacts/* release-files/$os/ 2>/dev/null || true
          done

          ls -R release-files

      - name: Tag
        run: |
          git config user.name "pamod-madubashana"
          git config user.email "pamod.main@gmail.com"
          git tag -a "${{ needs.bump-version.outputs.release_tag }}" -m "release"
          git push origin "${{ needs.bump-version.outputs.release_tag }}"

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump-version.outputs.release_tag }}
          name: ${{ needs.bump-version.outputs.release_tag }}
          body: ${{ github.event.inputs.release_notes }}
          files: release-files/**/*
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Push to download branch
        run: |
          mkdir upload && cd upload
          mkdir "${{ needs.bump-version.outputs.version }}"
          cp -r ../release-files/* "${{ needs.bump-version.outputs.version }}/"

          git init
          git config user.name "pamod-madubashana"
          git config user.email "pamod.main@gmail.com"
          git checkout -b download
          git add .
          git commit -m "${{ needs.bump-version.outputs.version }}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin download